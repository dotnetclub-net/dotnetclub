!function(){function e(){var e=$.extend({},$.summernote.options),a=$.extend({},e,{toolbar:[["style",["style"]],["format",["bold","italic","strikethrough","clear"]],["para",["ul","ol"]],["insert",["link","picture","insertCode"]]],styleTags:[{value:"p",title:"Paragraph",tag:"span"},{value:"h3",title:"Header",tag:"span"},{value:"blockquote",title:"Quote",tag:"span"}],codeLanguages:[{title:"C#",value:"csharp"},{title:"Razor(C#)",value:"cshtml"},{title:"JavaScript",value:"javascript"},{title:"HTML",value:"html"},{title:"CSS",value:"css"}],placeholder:"正文",height:300,callbacks:{onChange:function(){},onEnter:function(e){e.preventDefault(),e.stopPropagation();var t=$(this).data("summernote"),n=i.apply(this,[t,e]);n||t.invoke("editor.insertParagraph")},onPaste:function(e){e.preventDefault();var t,n=$(this).data("summernote"),o=(e.originalEvent||e).clipboardData||window.clipboardData,a=o.getData("text/html");if(a){t=$("<div>").append($(a));var i=l();c(t[0],null,i),$.each($.makeArray(t[0].childNodes),function(e,n){"P"!==n.nodeName||$.trim(n.textContent)||t[0].removeChild(n)});var r=n.invoke("editor.createRange"),s=n.layoutInfo.editable;r.isCollapsed()&&"P"===r.sc.nodeName&&r.sc.parentNode===s[0]||(n.invoke("editor.insertParagraph"),r=n.invoke("editor.createRange"));var u=$(r.sc).closest(".note-editable>p",s)[0];$.each($.makeArray(t[0].childNodes),function(e,t){s[0].insertBefore(t,u)}),n.invoke("editor.focus")}else a=o.getData("text/plain")||o.getData("text"),n.invoke("editor.insertText",a)}},buttons:{insertCode:t}});return a.modules.codePopover=n,a.modules.preventToolsInCodeBlocks=o,a.popover.codeLang=[["codeLang",["chooseCodeLanguage"]]],a}function t(e){var t=$.summernote.ui,n=t.button({contents:'<i class="note-icon-code"/>',tooltip:"Insert Code",click:function(){e.invoke("editor.formatBlock","PRE")}});return n.render()}function n(e){function t(e){var t=e.offset(),n=e.outerHeight(!0);return{left:t.left,top:t.top+n}}function n(){s=c.codeLanguages||[{title:"C#",value:"csharp"},{title:"Razor(C#)",value:"cshtml"},{title:"JavaScript",value:"javascript"},{title:"HTML",value:"html"},{title:"CSS",value:"css"},{title:"Razor(VB)",value:"vbhtml"},{title:"VB",value:"vb"},{title:"Java",value:"java"},{title:"PHP",value:"php"},{title:"PowerShell",value:"powershell"},{title:"Shell",value:"sh"}],e.memo("button.chooseCodeLanguage",function(){return l.buttonGroup([l.button({className:"dropdown-toggle",contents:'<span class="lang">选择语言</span> '+l.icon(c.icons.caret,"span"),data:{toggle:"dropdown"}}),l.dropdown({className:"dropdown-style",items:s,template:function(e){var t=e.title,n=e.style?' style="'+e.style+'" ':"",o=e.className?' className="'+e.className+'"':"";return"<span"+n+o+">"+t+"</span>"},click:function(t){if(i){t.preventDefault();var n,a,r=$(t.target).closest("[data-value]").data("value");n=o(r),n&&(i.attr("language",n.value),a=$(t.target).closest(".dropdown-menu").prev(".dropdown-toggle").find(".lang"),a.text(n.title),e.invoke("editor.afterCommand"),e.invoke("editor.focus"))}}})]).render()})}function o(e){var t;return $.each(s,function(n,o){if(o.value===e)return t=o,!1}),t}var i,r=this,l=$.summernote.ui,c=e.options,s=[];this.events={"summernote.mouseup":function(){r.update()},"summernote.keyup summernote.dialog.shown summernote.scroll":function(){r.hide()}},this.shouldInitialize=function(){return!0},this.initialize=function(){n(),this.$popover=l.popover({className:"note-code-popover",callback:function(e){}}).render().appendTo("body"),e.invoke("buttons.build",this.$popover.find(".popover-content"),c.popover.codeLang)},this.destroy=function(){this.$popover.remove()},this.update=function(){if(!e.invoke("editor.hasFocus"))return void this.hide();var n,r=e.invoke("editor.createRange");if(r.isCollapsed()&&(n=a(r.sc))){i=n;var l=t(n);this.$popover.css({display:"block",left:l.left,top:l.top});var c=n.attr("language"),s=this.$popover.find(".dropdown-toggle .lang"),u=o(c);s.text(u&&u.title||"选择语言")}else this.hide()},this.hide=function(){this.$popover.hide()}}function o(e){var t=this;this.events={"summernote.keyup summernote.mouseup summernote.change summernote.scroll":function(){t.update()}},this.initialize=function(){},this.update=function(){if(!e.invoke("editor.hasFocus"))return void e.invoke("toolbar.activate",!0);var t=e.invoke("editor.createRange"),n=a(t.sc),o=a(t.ec);n&&o&&n[0]===o[0]?e.invoke("toolbar.deactivate",!0):e.invoke("toolbar.activate",!0)}}function a(e){var t=$(e),n=t.is("pre")?t:t.parents("pre");return n.length?n:null}function i(e,t){function n(){e.invoke("editor.insertText","\n "),document.execCommand("delete",!1)}var o=e.invoke("editor.createRange"),a=$(o.sc).parents("pre");if(!t.ctrlKey&&!t.metaKey&&a.length){n();var i=/Edge\/\d+/.test(navigator.userAgent);if(i){var r="linebreak-patch",l=o.eo+2>=a[0].textContent.length;l&&!a.data(r)&&(a.data(r,!0),n())}return!0}}function r(e){var t=[{filter:["strike","del","s"],replacement:function(e){return"~~"+e+"~~"}},{filter:["i","em"],replacement:function(e){return"*"+e+"*"}},{filter:["b","strong"],replacement:function(e){return"**"+e+"**"}},{filter:["br"],replacement:function(){return"&nbsp;\n\n"}},{filter:["pre"],replacement:function(e,t){var n=t.getAttribute("language")||"";return"\n\n```"+n+"\n"+t.firstChild.textContent.replace(/\n+$/,"")+"\n```\n\n"}}],n=new TurndownService({codeBlockStyle:"fenced"});return $.each(t,function(e,t){n.addRule(t.filter.join(""),t)}),n.turndown(e)}function l(){var e=["script","style","link","iframe","frameset","object","embed","video","audio","canvas","svg","html","head","body","meta","input","select","option","button"],t=["div","main","nav","aside","section","article","footer","header","figure","form","legend","fieldset","dl","dt","dd","h1","h2","h4","h5","h6"],n=["p","br","h3","blockquote","strong","b","em","i","strike","ul","ol","li","a","img","pre"],o={a:["href","title","name"],img:["src","alt","title"],pre:["language"]};return{illegalTags:e,blockTags:t,allowedTags:n,allowedAttributes:o}}function c(e,t,n){if(e.childNodes.length&&c(e.childNodes[0],e,n),t){e.nextSibling&&c(e.nextSibling,t,n);var o=s(e,n);o!==e&&(o.nodeName?t.insertBefore(o,e):$.each(o,function(n,o){t.insertBefore(o,e)}),t.removeChild(e))}}function s(e,t){function n(e){for(var t,n,o=[],a=0;a<e.length;a++)n=e[a],t||(t=document.createElement("P"),o.push(t)),"P"!==n.nodeName?t.appendChild(n):(o.push(e[a]),t=null);return o}function o(e){var n=!1;return $.each(t.illegalTags,function(t,o){if(l(e,o))return n=!0,!1}),n}function a(e){var n=!1;return $.each(t.allowedTags,function(t,o){if(l(e,o))return n=!0,!1}),n}function i(e){var n=!1;return $.each(t.blockTags,function(t,o){if(l(e,o))return n=!0,!1}),n}function r(e){var n=[];$.each(e.attributes,function(o,a){var i=e.nodeName.toLowerCase();(!t.allowedAttributes[i]||t.allowedAttributes[i].indexOf(a.name)<0)&&n.push(a.name)}),$.each(n,function(t,n){e.removeAttribute(n)})}function l(e,t){return e.toUpperCase()===t.toUpperCase()}return 3===e.nodeType?e:"A"!==e.nodeName||$.trim(e.textContent)||e.childNodes.length?1!==e.nodeType||o(e.nodeName)?document.createTextNode(""):a(e.nodeName)?(r(e),e):i(e.nodeName)?n(e.childNodes):document.createTextNode(e.textContent):document.createTextNode("")}function u(e){return e.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/&#[\d]+;/g,"")}$(document).ready(function(){var t=e();$("#content-editor").summernote(t),$("#topic-type-dropdown .topic-type-item").on("click",function(e){var t=$(this);$("#topic-type-dropdown .topic-type-item").removeAttr("selected"),t.attr("selected","selected"),$("#topic-type-dropdown .selected-type").text(t.text())}),$("#submit-create").on("click",function(){var e=$(this),t=$("#content-editor").data("summernote"),n=t.code(),o=$("<div>").append(n),a=l();c(o[0],null,a);var i=r(o.html()),s=u(i),d=$("#new-topic-title").val(),p=$("#topic-type-dropdown .topic-type-item[selected]>a").attr("attr-value"),v={title:u(d),content:s,type:p};v.title&&v.content&&v.type&&(e.attr("disabled","disabled"),$.post(window.createTopicUrl,v).done(function(){location.replace("/")}).fail(function(){console.log("error on creating new topic"),e.removeAttr("disabled")}))})})}();